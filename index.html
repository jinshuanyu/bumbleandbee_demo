<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bumble and Bee: Interactive Workbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --book1-primary: #FF8C42; --book1-bg: #FFF3E6;
            --book2-primary: #4CAF50; --book2-bg: #E8F5E9;
            --book3-primary: #42A5F5; --book3-bg: #E3F2FD;
            --honey-yellow: #FFD93D; --bee-black: #2D3436;
            --white: #FFFFFF; --gray-light: #F5F5F5;
        }
        body {
            font-family: 'ABeeZee', sans-serif;
            background-color: #FFF9C4;
            overscroll-behavior: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100vh; height: 100dvh; width: 100vw; 
            overflow: hidden; display: flex; flex-direction: column;
        }
        
        /* Layouts */
        .container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .books-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px 10px; 
            width: 100%; 
        }
        
        .book-card { background: var(--white); border: 3px solid var(--bee-black); border-radius: 16px; padding: 10px; cursor: pointer; transition: all 0.2s ease; text-align: center; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 160px; }
        .book-card:active { transform: scale(0.97); }

        .book-card.book1 { border-color: var(--book1-primary); } .book-card.book1 .book-cover { background: var(--book1-bg); }
        .book-card.book2 { border-color: var(--book2-primary); } .book-card.book2 .book-cover { background: var(--book2-bg); }
        .book-card.book3 { border-color: var(--book3-primary); } .book-card.book3 .book-cover { background: var(--book3-bg); }
        
        .book-cover { font-size: 3rem; margin-bottom: 8px; border-radius: 8px; padding: 4px; line-height: 1.1; letter-spacing: -2px; }
        .book-title { font-size: 1rem; font-weight: 800; color: var(--bee-black); margin-bottom: 6px; line-height: 1.1; white-space: normal; overflow: visible; height: auto; }
        .book-progress { font-size: 0.75rem; color: #666; margin-top: auto; }
        
        /* Header */
        .nav-header { display: flex; align-items: center; padding: 10px 15px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 50; height: 60px; flex-shrink: 0; }
        .nav-title-block { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .nav-main-title { font-size: 1.2rem; font-weight: bold; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .back-btn, .settings-btn { background: var(--white); border: 2px solid var(--bee-black); border-radius: 50%; width: 42px; height: 42px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .back-btn { margin-right: 10px; } .settings-btn { margin-left: 10px; }

        .hidden { display: none !important; }
        .zh-text { font-family: 'Noto Sans TC', sans-serif; }
        .star-badge { background: #FFF9C4; padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 1rem; border: 2px solid #FCD34D; display: inline-flex; align-items: center; gap: 4px; }
        
        /* Orientation Overlay */
        #orientation-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; padding: 2rem; }
        #orientation-overlay.show { display: flex; }
        .rotate-icon { font-size: 5rem; animation: rotate-phone 2s ease-in-out infinite; margin-bottom: 1.5rem; }
        @keyframes rotate-phone { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(90deg); } }
        
        /* Game Areas */
        #sky-area { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; align-content: center; flex-wrap: wrap; padding: 10px; position: relative; background: linear-gradient(180deg, #bfeaff 0%, #e6ffe6 60%, #b3ffb3 100%); }
        #garden-area { width: 100%; display: flex; justify-content: center; align-items: flex-end; flex-wrap: wrap; padding-bottom: 20px; gap: 10px; background: #b3ffb3; min-height: 130px; }
        
        .bee-item, .honeypot-item { width: 80px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 5px; cursor: grab; z-index: 100; position: relative; animation: float 3s ease-in-out infinite; touch-action: none; }
        .bee-icon, .honeypot-item-icon { font-size: 3rem; line-height: 1; filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.2)); }
        .bee-label, .honeypot-item-label { background: rgba(255,255,255,0.95); border: 2px solid #ffa500; border-radius: 10px; padding: 2px 8px; font-size: 16px; font-weight: 900; color: #d35400; margin-top: -12px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 101; }
        
        /* Honeypot specific overrides */
        .honeypot-item-label { border-color: #b45309; color: #92400e; margin-top: -10px; }
        
        /* Targets */
        .flower-target, .honeypot-target { width: 90px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 5px; position: relative; transition: transform 0.2s; }
        .hive-cell { width: 100px; height: 110px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); transition: transform 0.2s; margin: 5px; }
        
        .flower-icon, .honeypot-icon { font-size: 3rem; line-height: 1; z-index: 1; }
        .flower-label, .honeypot-label { font-size: 18px; font-weight: bold; color: #2e7d32; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff; margin-top: 2px; z-index: 2; font-family: 'Noto Sans TC', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; line-height: 1.2; }
        .hive-label { font-size: 18px; font-weight: bold; color: #78350f; font-family: 'Noto Sans TC', sans-serif; }
        .flower-emoji, .honeypot-emoji { font-size: 1.5rem; margin-top: 2px; }
        
        /* Highlight State */
        .highlight { transform: scale(1.15) !important; filter: drop-shadow(0 0 8px gold); z-index: 10; }
        
        .dragging-clone { position: fixed; z-index: 99999; pointer-events: none; transform: scale(1.2) rotate(-10deg); opacity: 0.9; }
        .opacity-0 { opacity: 0 !important; visibility: hidden !important; }

        /* Landed Items */
        .landed-bee { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); z-index: 200; pointer-events: auto; cursor: pointer; display: flex; flex-direction: column; align-items: center; animation: happy-land 0.5s ease-out; }
        .landed-bee .bee-icon { font-size: 2.5rem; }
        .landed-bee .bee-label { font-size: 12px; padding: 2px 6px; margin-top: -8px; }
        
        /* Clouds */
        .cloud { position: absolute; font-size: 3rem; opacity: 0.6; pointer-events: none; z-index: 1; }
        .cloud-1 { top: 10%; left: 5%; animation: float-cloud 15s ease-in-out infinite; }
        .cloud-2 { top: 15%; right: 10%; font-size: 4rem; animation: float-cloud 20s ease-in-out infinite reverse; }
        .cloud-3 { top: 25%; left: 30%; font-size: 2.5rem; animation: float-cloud 18s ease-in-out infinite; animation-delay: -5s; }
        .cloud-4 { top: 5%; right: 25%; font-size: 2rem; animation: float-cloud 12s ease-in-out infinite reverse; animation-delay: -3s; }
        @keyframes float-cloud { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(20px); } }
        @keyframes happy-land { 0% { transform: translateX(-50%) scale(0.1); } 80% { transform: translateX(-50%) scale(1.2); } 100% { transform: translateX(-50%) scale(1); } }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Listen Game */
        .listen-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 15px; background: linear-gradient(180deg, #e0f7fa 0%, #b2ebf2 100%); overflow-y: auto; padding-bottom: 90px; }
        .sentence-box-compact { font-size: 1.3rem; background: white; padding: 15px; border-radius: 16px; border: 3px solid var(--bee-black); margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 600px; width: 100%; line-height: 1.5; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; justify-content: center; }
        .inline-speaker { background: #E3F2FD; border: 2px solid #42A5F5; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; margin-right: 8px; flex-shrink: 0; }
        .word-bank { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; max-width: 500px; width: 100%; }
        .word-option { min-width: 70px; padding: 8px 12px; background: var(--honey-yellow); border: 2px solid var(--bee-black); border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: all 0.2s; touch-action: manipulation; }
        .word-option:active { transform: scale(0.95); }
        .word-option.selected { background: #FFA500; transform: scale(1.05); }
        .word-option.correct { background: #81C784; border-color: #2E7D32; }
        .word-option.wrong { background: #E57373; border-color: #C62828; }
        .blank-spot { display: inline-block; min-width: 60px; border-bottom: 2px dashed var(--bee-black); color: #1976D2; font-weight: bold; padding: 0 4px; transition: all 0.3s; text-align: center; }
        .blank-spot.filled { border-bottom-style: solid; background: rgba(255,215,0,0.3); border-radius: 4px; }
        
        .game-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: rgba(255,255,255,0.9); border-top: 1px solid #ddd; display: flex; justify-content: center; align-items: center; gap: 15px; z-index: 500; }
        .next-question-btn { background: linear-gradient(135deg, #81C784, #4CAF50); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 100%; max-width: 250px; }
        .next-question-btn.hidden { display: none; }
        .progress-dots { display: flex; gap: 6px; }
        .progress-dot { width: 10px; height: 10px; border-radius: 50%; background: #ddd; border: 1px solid #999; }
        .progress-dot.current { background: var(--honey-yellow); border-color: #F59E0B; transform: scale(1.2); }
        .progress-dot.completed { background: #81C784; border-color: #2E7D32; }

        /* Story Drawing */
        .draw-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f5f5f5; }
        .draw-canvas-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; padding: 10px; }
        .draw-canvas { border: 3px solid var(--bee-black); border-radius: 10px; background: white; touch-action: none; max-width: 100%; max-height: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        /* Wrap toolbar */
        .draw-toolbar { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 4px; background: white; border-top: 2px solid #ddd; flex-wrap: wrap; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
        .tool-btn { width: 40px; height: 40px; border-radius: 8px; border: 1px solid #ccc; background: #fff; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .tool-btn.active { background: #FFF9C4; border-color: #F59E0B; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .color-btn { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); flex-shrink: 0; }
        .color-btn.active { transform: scale(1.1); border-color: #333; }
        .done-btn { background: #FCD34D; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }

        /* Themes Grid */
        .themes-row-4{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; max-width: 800px; margin: 0 auto; padding: 10px; }
        .theme-tile{ aspect-ratio: 1 / 1; padding: 6px; display:flex; flex-direction:column; align-items:center; justify-content:space-between; text-align:center; background: white; border: 2px solid var(--bee-black); border-radius: 12px; cursor: pointer; }
        .theme-tile .emoji{ font-size: 2.5rem; line-height: 1; }
        .theme-tile .label{ font-weight: 800; font-size: 0.85rem; color: var(--bee-black); line-height: 1.1; margin-top: 4px; }
        .theme-tile .modes { width: 100%; display:flex; flex-direction:column; gap: 4px; font-size: 0.9rem; font-weight: 800; }
        .theme-tile .mode-row{ display:flex; align-items:center; justify-content:center; gap: 4px; }
        .text-yellow-400 { color: #FACC15; }
        
        /* Modals */
        #audio-modal, #modal-feedback, #modal-reset { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: white; border-radius: 1rem; padding: 2rem; text-align: center; border: 4px solid #FBBF24; width: 90%; max-width: 400px; }
        
        .animate-pop { animation: pop 0.3s ease-out; }
    </style>
</head>
<body class="text-gray-800">

    <div id="orientation-overlay">
        <div class="rotate-icon">üì±</div>
        <h2 class="text-2xl font-bold mb-2">Rotate Device</h2>
    </div>

    <div id="app" class="container"></div>

    <!-- Modals -->
    <div id="audio-modal">
        <div class="modal-content">
            <div style="font-size: 3.5rem; margin-bottom: 0.5rem; display: flex; justify-content: center; gap: 10px;">
                <span>üêù</span><span>üê∏</span><span>üêù</span>
            </div>
            <h2 class="text-2xl font-bold mb-6" style="line-height: 1.2;">
                <span style="color: #F97316;">Bumble</span> 
                <span style="color: #FACC15;">and Bee</span>
            </h2>
            <button id="start-btn" class="start-btn" style="width:100%; background:#FBBF24; padding:12px; border-radius:10px; font-weight:bold; font-size: 1.2rem;">Start Playing üîä</button>
        </div>
    </div>

    <div id="modal-feedback" class="hidden">
        <div class="modal-content animate-pop">
            <div id="fb-icon" class="text-6xl mb-2">üèÜ</div>
            <h2 id="fb-title" class="text-2xl font-bold mb-2">Great Job!</h2>
            <div id="fb-stars" class="text-4xl mb-4 text-yellow-400">‚≠ê‚≠ê‚≠ê</div>
            <button id="fb-continue-btn" class="start-btn" style="width:100%; background:#FBBF24; padding:12px; border-radius:10px; font-weight:bold;">Continue</button>
        </div>
    </div>

    <div id="modal-reset" class="hidden">
        <div class="modal-content animate-pop" style="border-color: #EF4444;">
            <div class="text-4xl mb-2">‚ö†Ô∏è</div>
            <h2 class="text-lg font-bold mb-4">Reset Progress?</h2>
            <div class="flex gap-2">
                <button id="confirm-reset-btn" style="flex:1; background:#EF4444; color:white; padding:10px; border-radius:8px;">Reset</button>
                <button id="cancel-reset-btn" style="flex:1; background:#E5E7EB; padding:10px; border-radius:8px;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // DATA
        const MANIFEST = {
            books: [
                { id: "1", title: "Let's BEE Thankful", cover: "üéÉü•ß", subtitle: "Fall & Thanksgiving", class: "book1" },
                { id: "2", title: "Let's Play Make BEE-lieve", cover: "üé≠üó∫Ô∏è", subtitle: "Imagination & Play", class: "book2" },
                { id: "3", title: "Don't Worry, BEE Happy", cover: "üì∏üòä", subtitle: "Friendship & Feelings", class: "book3" }
            ]
        };

        const BOOK_DATA = {
            "1": {
                games: {
                    "vocab": { sets: [{ id: "B1-V01", title: "Fall Fun", icon: "üçÇ" }, { id: "B1-V02", title: "Baking", icon: "ü•ß" }, { id: "B1-V03", title: "Winter", icon: "‚ùÑÔ∏è" }]},
                    "listen": { sets: [{ id: "B1-L01", title: "Fall Sentences", icon: "üçÅ" }, { id: "B1-L02", title: "Baking Sentences", icon: "üßÅ" }, { id: "B1-L03", title: "Winter Sentences", icon: "‚ùÑÔ∏è" }]},
                    "story": { sets: [{ id: "B1-S01", title: "Paint the Pumpkin", icon: "üéÉ" }]}
                },
                gameData: {
                    "B1-V01": { type: "vocab_match", motif: "bee-flower", title: "Fall Fun Words", pairs: [
                        { id: "paint", en: "paint", zh: "Áï´Áï´", emoji: "üé®" }, { id: "jump", en: "jump", zh: "Ë∑≥Ë∫ç", emoji: "ü¶ò" },
                        { id: "wish", en: "wish", zh: "Ë®±È°ò", emoji: "üåü" }, { id: "pumpkin", en: "pumpkin", zh: "ÂçóÁìú", emoji: "üéÉ" },
                        { id: "list", en: "list", zh: "Ê∏ÖÂñÆ", emoji: "üìù" }
                    ]},
                    "B1-V02": { type: "vocab_match", motif: "bee-honeypot", title: "Baking Words", pairs: [
                        { id: "bake", en: "bake", zh: "ÁÉòÁÉ§", emoji: "üë©‚Äçüç≥" }, { id: "forget", en: "forget", zh: "ÂøòË®ò", emoji: "ü§î" },
                        { id: "pie", en: "pie", zh: "Ê¥æ", emoji: "ü•ß" }, { id: "butter", en: "butter", zh: "Â•∂Ê≤π", emoji: "üßà" },
                        { id: "get", en: "get", zh: "ÂèñÂæó", emoji: "ü§≤" }
                    ]},
                    "B1-V03": { type: "vocab_match", motif: "honeypot-hive", title: "Winter Words", pairs: [
                        { id: "winter", en: "winter", zh: "ÂÜ¨Â§©", emoji: "‚ùÑÔ∏è" }, { id: "room", en: "room", zh: "ÊàøÈñì", emoji: "üõãÔ∏è" },
                        { id: "friend", en: "friend", zh: "ÊúãÂèã", emoji: "üë´" }, { id: "favorite", en: "favorite", zh: "ÊúÄÊÑõÁöÑ", emoji: "‚ù§Ô∏è" },
                        { id: "practice", en: "practice", zh: "Á∑¥Áøí", emoji: "üìö" }
                    ]},
                    "B1-L01": { type: "listening_fill", title: "Fall Sentences", questions: [
                        { text: "____ in leaves was so much fun!", blank: "Jumping", fullSentence: "Jumping in leaves was so much fun!", options: ["paint", "Jumping", "wish", "list"] },
                        { text: "I will look at our ____, Bumble.", blank: "list", fullSentence: "I will look at our list, Bumble.", options: ["list", "jump", "wish", "pumpkin"] },
                        { text: "We ____  for a pumpkin!!!", blank: "wish", fullSentence: "We wish for a pumpkin!!!", options: ["paint", "jump", "list", "wish"] },
                        { text: "We turned Froggy into a ____ !", blank: "pumpkin", fullSentence: "We turned Froggy into a pumpkin!", options: ["paint", "pumpkin", "list", "jump"] },
                        { text: "Let's carve and ____ them!", blank: "paint", fullSentence: "Let's carve and paint them!", options: ["paint", "jump", "pumpkin", "wish"] }
                    ]},
                    "B1-L02": { type: "listening_fill", title: "Apple Pie Sentences", questions: [
                        { text: "I am about to ____ my famous apple pie!", blank: "bake", fullSentence: "I am about to bake my famous apple pie!", options: ["butter", "bake", "forget", "pie"] },
                        { text: "Do not worry. We will ____ the butter.", blank: "get", fullSentence: "Do not worry. We will get the butter.", options: ["get", "bake", "forget", "pie"] },
                        { text: "And we will not ____ .", blank: "forget", fullSentence: "And we will not forget.", options: ["forget", "get", "bake", "butter"] },
                        { text: "Maybe I should write down ____ ?", blank: "butter", fullSentence: "Maybe I should write down butter?", options: ["butter", "pie", "get", "forget"] },
                        { text: "Here you go, Froggy. Everything you need to bake your ____ !", blank: "pie", fullSentence: "Here you go, Froggy. Everything you need to bake your pie!", options: ["pie", "butter", "bake", "forget"] }
                    ]},
                    "B1-L03": { type: "listening_fill", title: "Winter Sentences", questions: [
                        { text: "____ is almost here. I can feel it in the air.", blank: "Winter", fullSentence: "Winter is almost here. I can feel it in the air.", options: ["Winter", "room", "friends", "favorite"] },
                        { text: "It is my ____ season.", blank: "favorite", fullSentence: "It is my favorite season.", options: ["favorite", "practice", "room", "Winter"] },
                        { text: "I am not very good, but I have all winter to ____ !", blank: "practice", fullSentence: "I am not very good, but I have all winter to practice!", options: ["practice", "room", "favorite", "friends"] },
                        { text: "There is not enough ____ !", blank: "room", fullSentence: "There is not enough room!", options: ["room", "Winter", "practice", "friends"] },
                        { text: "I guess there is always room for marshmallows and ____ .", blank: "friends", fullSentence: "I guess there is always room for marshmallows and friends.", options: ["friends", "favorite", "room", "practice"] }
                    ]},
                    "B1-S01": { type: "story_draw", title: "Paint the Pumpkin", backgroundImage: "B1A1Pumpkin.svg" }
                }
            },
            "2": { games: {}, gameData: {} }, "3": { games: {}, gameData: {} }
        };

        const BOOK_THEMES = {
            "1": { themes: [
                { id: "T01", title: "Pumpkin", emoji: "üéÉ", vocabId: "B1-V01", listenId: "B1-L01", headerTitle: "Chapter 1: Let's Paint Pumpkins!" },
                { id: "T02", title: "Apple Pie", emoji: "ü•ß", vocabId: "B1-V02", listenId: "B1-L02", headerTitle: "Chapter 2: Froggy's Famous Apple Pie" },
                { id: "T03", title: "Winter", emoji: "‚ùÑÔ∏è", vocabId: "B1-V03", listenId: "B1-L03", headerTitle: "Chapter 3: Froggy's Winter Hideout" }
            ], storyTitle: "Activities" },
            "2": { themes: [{id:"T01",title:"Chapter 1"},{id:"T02",title:"Chapter 2"},{id:"T03",title:"Chapter 3"}] },
            "3": { themes: [{id:"T01",title:"Chapter 1"},{id:"T02",title:"Chapter 2"},{id:"T03",title:"Chapter 3"}] }
        };

        // CORE MODULES
        class Store {
            constructor() { this.KEY = 'bumble_bee_v3'; this.state = this.load(); }
            load() { try { return JSON.parse(localStorage.getItem(this.KEY)) || this.getDefault(); } catch { return this.getDefault(); } }
            getDefault() { return { version: 3, games: {}, tutorialShown: false }; }
            save() { localStorage.setItem(this.KEY, JSON.stringify(this.state)); }
            markTutorialShown() { this.state.tutorialShown = true; this.save(); }
            hasTutorialBeenShown() { return this.state.tutorialShown; }
            completeGame(id, stars, mistakes) {
                const ex = this.state.games[id];
                if (!ex || stars > ex.stars) { this.state.games[id] = { completed: true, stars, mistakes }; this.save(); }
            }
            getStars(id) { return this.state.games[id]?.stars || 0; }
            isComplete(id) { return !!this.state.games[id]?.completed; }
            getTotalStars() { return Object.values(this.state.games).reduce((s, g) => s + (g.stars||0), 0); }
            reset() { this.state = this.getDefault(); this.save(); }
        }

        class SoundFX {
            constructor() { this.ctx = null; this.enabled = false; }
            init() { try { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); this.enabled=true; if(this.ctx.state==='suspended') this.ctx.resume(); } catch(e){} }
            play(f,t,type='sine') { if(!this.enabled||!this.ctx)return; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.type=type; o.frequency.value=f; g.gain.setValueAtTime(0.1,this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+t); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+t); }
            correct() { this.play(523,0.1); setTimeout(()=>this.play(659,0.1),100); setTimeout(()=>this.play(784,0.2),200); }
            incorrect() { this.play(180,0.3,'sawtooth'); }
            click() { this.play(800,0.05); }
            complete() { [523,659,784,1047].forEach((f,i)=>setTimeout(()=>this.play(f,0.3),i*150)); }
        }

        class AudioManager {
            constructor() { this.synth = window.speechSynthesis; }
            init() { this.synth.speak(new SpeechSynthesisUtterance('')); }
            speak(txt) { if(!txt)return; this.synth.cancel(); const u=new SpeechSynthesisUtterance(txt); u.lang='en-US'; u.rate=0.9; this.synth.speak(u); }
            async playSentence(id, idx, txt) { this.speak(txt); }
        }

        const app = { 
            store: new Store(), 
            sfx: new SoundFX(), 
            audio: new AudioManager(), 
            init() { 
                document.getElementById('start-btn').onclick = () => {
                    document.getElementById('audio-modal').style.display='none'; 
                    app.sfx.init(); 
                    app.audio.init(); 
                    Views.home();
                }; 
                
                document.getElementById('orientation-overlay').onclick = () => app.checkOrient(); 
                window.addEventListener('resize', () => app.checkOrient());
                app.checkOrient(); 
                
                document.getElementById('confirm-reset-btn').onclick = () => {
                    app.store.reset();
                    document.getElementById('modal-reset').classList.add('hidden');
                    Views.home();
                }; 
                document.getElementById('cancel-reset-btn').onclick = () => {
                    document.getElementById('modal-reset').classList.add('hidden');
                }; 
            }, 
            checkOrient() { 
                const bad = window.innerWidth < 600 && window.innerHeight > window.innerWidth; 
                document.getElementById('orientation-overlay').className = bad ? 'show' : ''; 
            } 
        };

        // VIEWS
        const Views = {
            container: document.getElementById('app'),
            
            home() {
                const stars = app.store.getTotalStars();
                this.container.innerHTML = `
                    <div class="nav-header">
                        <div class="star-badge text-yellow-500">‚≠ê ${stars}</div>
                        <div class="nav-title-block"><div class="nav-main-title">üìö Select a Book</div></div>
                        <button class="settings-btn" onclick="document.getElementById('modal-reset').classList.remove('hidden')">‚ü≤</button>
                    </div>
                    <div class="books-grid overflow-y-auto pb-10">
                        ${MANIFEST.books.map(b => {
                            const earned = this.getBookStars(b.id);
                            return `
                                <div class="book-card ${b.class}" onclick="Views.bookThemes('${b.id}')">
                                    <div class="book-cover">${b.cover}</div>
                                    <div class="book-title">${b.title}</div>
                                    <div class="text-yellow-400" style="font-size:1.5rem; letter-spacing:2px;">${this.renderStars(earned, 9)}</div>
                                </div>`;
                        }).join('')}
                    </div>`;
            },

            bookThemes(bid) {
                const b = MANIFEST.books.find(x => x.id === bid);
                const themes = BOOK_THEMES[bid]?.themes || [];
                const storySets = BOOK_DATA[bid]?.games?.story?.sets || [];
                const completedStories = storySets.filter(s => app.store.isComplete(s.id)).length;

                while(themes.length < 3) themes.push({id:`T0${themes.length+1}`, title:`Chapter ${themes.length+1}`, emoji:'üîí'});

                this.container.innerHTML = `
                    <div class="nav-header">
                        <button class="back-btn" onclick="Views.home()">‚Üê</button>
                        <div class="nav-title-block">
                            <div class="nav-main-title">${b.title}</div>
                        </div>
                        <div style="width:40px"></div>
                    </div>
                    <div class="overflow-y-auto" style="flex:1;">
                        <div class="themes-row-4 mt-4">
                            ${themes.slice(0,3).map(t => {
                                const vStars = t.vocabId ? app.store.getStars(t.vocabId) : 0;
                                const lStars = t.listenId ? app.store.getStars(t.listenId) : 0;
                                const locked = !t.vocabId && !t.listenId;
                                const stars = (n) => `<span class="text-yellow-400 tracking-tighter">${'‚òÖ'.repeat(Math.min(3,n))}${'‚òÜ'.repeat(3-Math.min(3,n))}</span>`;
                                
                                return `
                                <div class="theme-tile ${locked?'opacity-60':''}" onclick="${locked?'':`Views.themeSelect('${bid}','${t.id}')`}">
                                    <div class="emoji">${t.emoji||'üìò'}</div>
                                    <div class="label" style="font-size:1rem;">${t.title}</div>
                                    <div class="modes">
                                        <div class="mode-row"><span>üî°</span>${t.vocabId ? stars(vStars) : '‚è≥'}</div>
                                        <div class="mode-row"><span>üëÇ</span>${t.listenId ? stars(lStars) : '‚è≥'}</div>
                                    </div>
                                </div>`;
                            }).join('')}
                            
                            <div class="theme-tile" onclick="Views.storyList('${bid}')">
                                <div class="emoji">üé®</div>
                                <div class="label" style="font-size:1rem;">Activities</div>
                                <div class="modes">
                                    <div class="mode-row text-green-600">${completedStories}/${Math.max(1, storySets.length)} Done</div>
                                    <div class="mode-row"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            },

            themeSelect(bid, tid) {
                const b = MANIFEST.books.find(x => x.id === bid);
                const t = BOOK_THEMES[bid].themes.find(x => x.id === tid);
                const vStars = t.vocabId ? app.store.getStars(t.vocabId) : 0;
                const lStars = t.listenId ? app.store.getStars(t.listenId) : 0;
                const rStars = (n) => `<span class="text-yellow-400 text-2xl tracking-widest">${'‚òÖ'.repeat(n)}${'‚òÜ'.repeat(3-n)}</span>`;

                this.container.innerHTML = `
                    <div class="nav-header">
                        <button class="back-btn" onclick="Views.bookThemes('${bid}')">‚Üê</button>
                        <div class="nav-title-block">
                            <div class="nav-main-title">${t.headerTitle || t.title}</div>
                        </div>
                        <div style="width:40px"></div>
                    </div>
                    <div class="overflow-y-auto mt-4 p-4 flex flex-wrap justify-center gap-4">
                        <div class="book-card book${bid} ${!t.vocabId?'opacity-50':''}" style="width:100%; max-width:280px;" onclick="${t.vocabId?`Views.play('${bid}','${t.vocabId}','${tid}')`:''}">
                            <div class="book-cover">üî§üß©</div>
                            <div class="book-title" style="font-size:1.5rem;">Vocabulary</div>
                            ${t.vocabId ? rStars(vStars) : '<div class="book-progress">Coming Soon</div>'}
                        </div>
                        <div class="book-card book${bid} ${!t.listenId?'opacity-50':''}" style="width:100%; max-width:280px;" onclick="${t.listenId?`Views.play('${bid}','${t.listenId}','${tid}')`:''}">
                            <div class="book-cover">üëÇüîä</div>
                            <div class="book-title" style="font-size:1.5rem;">Listening</div>
                            ${t.listenId ? rStars(lStars) : '<div class="book-progress">Coming Soon</div>'}
                        </div>
                    </div>`;
            },
            
            play(bid, gid, tid) {
                const gData = BOOK_DATA[bid].gameData[gid];
                if(gData.type === 'vocab_match') new VocabGame(bid, gid, tid, gData).start();
                if(gData.type === 'listening_fill') new ListenGame(bid, gid, tid, gData).start();
                if(gData.type === 'story_draw') new DrawGame(bid, gid, tid, gData).start();
            },
            
            storyList(bid) {
                const sets = BOOK_DATA[bid]?.games?.story?.sets || [];
                this.container.innerHTML = `
                    <div class="nav-header">
                        <button class="back-btn" onclick="Views.bookThemes('${bid}')">‚Üê</button>
                        <div class="nav-title-block"><div class="nav-main-title">Story Activities</div></div>
                        <div style="width:40px"></div>
                    </div>
                    <div class="books-grid overflow-y-auto mt-4">
                        ${sets.map(s => `
                            <div class="book-card book${bid}" onclick="Views.play('${bid}','${s.id}','story')">
                                <div class="book-cover text-5xl">${s.icon}</div>
                                <div class="book-title">${s.title}</div>
                                <div class="book-progress">${app.store.isComplete(s.id)?'‚úì Done':'Tap to Play'}</div>
                            </div>
                        `).join('')}
                    </div>`;
            },

            getBookStars(bid) { let t=0; Object.keys(app.store.state.games).forEach(k=>{if(k.startsWith('B'+bid)) t+=app.store.state.games[k].stars||0;}); return t; },
            renderStars(n, max) { const f = Math.min(3, Math.floor((n/max)*3)); return '‚òÖ'.repeat(f)+'‚òÜ'.repeat(3-f); }
        };

        // GAMES
        class Game {
            constructor(bid, gid, tid, data) { this.bid=bid; this.gid=gid; this.tid=tid; this.data=data; this.mistakes=0; }
            header() {
                const backFn = this.tid === 'story' ? `Views.storyList('${this.bid}')` : `Views.themeSelect('${this.bid}','${this.tid}')`;
                return `
                <div class="nav-header">
                    <button class="back-btn" onclick="${backFn}">‚Üê</button>
                    <div class="nav-title-block"><div class="nav-main-title">${this.data.title}</div></div>
                    <div style="width:40px"></div>
                </div>`;
            }
            finish() {
                let stars = 3; if(this.mistakes > 0) stars=2; if(this.mistakes > 2) stars=1;
                if(this.data.type === 'story_draw') stars = 0; 
                
                app.store.completeGame(this.gid, stars, this.mistakes);
                app.sfx.complete();
                
                const el = document.getElementById('modal-feedback');
                document.getElementById('fb-stars').innerHTML = stars===0 ? '' : '‚òÖ'.repeat(stars)+'‚òÜ'.repeat(3-stars);
                document.getElementById('fb-continue-btn').onclick = () => {
                    el.classList.add('hidden');
                    if(this.tid === 'story') Views.storyList(this.bid);
                    else Views.themeSelect(this.bid, this.tid);
                };
                el.classList.remove('hidden');
            }
        }

        class VocabGame extends Game {
            start() {
                const config = this.getConfig();
                Views.container.innerHTML = `
                    ${this.header()}
                    <div style="flex:1; display:flex; flex-direction:column; width:100%; overflow:hidden;">
                        <div id="sky-area" style="background:${config.sky}">${[1,2,3,4].map(i=>`<div class="cloud cloud-${i}">‚òÅÔ∏è</div>`).join('')}</div>
                        <div id="garden-area" class="${config.gardenClass}" style="background:${config.garden}"></div>
                    </div>`;
                
                const garden = document.getElementById('garden-area');
                const sky = document.getElementById('sky-area');
                
                // SHUFFLE TARGETS (New)
                const shuffledTargets = [...this.data.pairs].sort(() => Math.random() - 0.5);
                
                shuffledTargets.forEach(p => {
                    const t = document.createElement('div');
                    t.className = config.targetClass; t.dataset.id = p.id;
                    t.innerHTML = config.renderTarget(p);
                    garden.appendChild(t);
                });
                
                // SHUFFLE DRAGGABLES (Existing, but kept separate)
                [...this.data.pairs].sort(()=>Math.random()-0.5).forEach((p, i) => {
                    const d = document.createElement('div');
                    d.className = config.dragClass; d.dataset.id = p.id; d.dataset.word = p.en;
                    d.innerHTML = config.renderDrag(p);
                    d.style.animationDelay = (i*0.2)+'s';
                    d.ontouchstart = d.onmousedown = (e) => this.drag(e, d);
                    sky.appendChild(d);
                });
                this.matched = 0;
            }
            
            getConfig() {
                const m = this.data.motif;
                if(m === 'honeypot-hive') return {
                    sky: 'linear-gradient(180deg, #bfeaff 0%, #e6ffe6 60%, #b3ffb3 100%)', garden:'', gardenClass:'hive-area',
                    targetClass: 'hive-cell', dragClass: 'honeypot-item',
                    renderTarget: (p) => `<div class="hive-cell-inner"><div class="hive-label zh-text">${p.zh}</div></div>`,
                    renderDrag: (p) => `<div class="honeypot-item-icon">üçØ</div><div class="honeypot-item-label">${p.en}</div>`,
                    landed: (p) => `<div class="landed-pot-hive">üçØ</div>`
                };
                if(m === 'bee-honeypot') return {
                    sky: 'linear-gradient(180deg, #bfeaff 0%, #fef3c7 60%, #fde68a 100%)', 
                    garden:'linear-gradient(180deg, #fde68a 0%, #fbbf24 100%)', gardenClass:'',
                    targetClass: 'honeypot-target', dragClass: 'bee-item',
                    renderTarget: (p) => `<div class="honeypot-icon">üçØ</div><div class="honeypot-label zh-text">${p.zh}</div>`,
                    renderDrag: (p) => `<div class="bee-icon">üêù</div><div class="bee-label">${p.en}</div>`,
                    landed: (p) => `<div class="landed-bee"><div class="bee-icon">üêù</div><div class="bee-label">${p.en}</div></div>`
                };
                return {
                    sky: 'linear-gradient(180deg, #bfeaff 0%, #e6ffe6 60%, #b3ffb3 100%)', garden:'#b3ffb3', gardenClass:'',
                    targetClass: 'flower-target', dragClass: 'bee-item',
                    renderTarget: (p) => `<div class="flower-icon">üåº</div><div class="flower-label zh-text">${p.zh}</div>`,
                    renderDrag: (p) => `<div class="bee-icon">üêù</div><div class="bee-label">${p.en}</div>`,
                    landed: (p) => `<div class="landed-bee"><div class="bee-icon">üêù</div><div class="bee-label">${p.en}</div></div>`
                };
            }

            drag(e, el) {
                e.preventDefault();
                app.audio.speak(el.dataset.word); app.sfx.click();
                
                const clone = el.cloneNode(true);
                clone.classList.add('dragging-clone'); clone.style.animation = 'none';
                document.body.appendChild(clone);
                
                // FORCE opacity on element immediately
                el.classList.add('opacity-0');
                el.style.opacity = '0';

                const r = el.getBoundingClientRect();
                const tStart = e.touches ? e.touches[0] : e;
                const offsetX = tStart.clientX - r.left;
                const offsetY = tStart.clientY - r.top;

                const move = (ev) => {
                    const t = ev.touches ? ev.touches[0] : ev;
                    clone.style.left = (t.clientX - offsetX) + 'px';
                    clone.style.top = (t.clientY - offsetY) + 'px';
                    
                    // Highlight logic
                    clone.style.display = 'none';
                    const elem = document.elementFromPoint(t.clientX, t.clientY);
                    clone.style.display = 'block';
                    
                    document.querySelectorAll('.highlight').forEach(h => h.classList.remove('highlight'));
                    if(elem) {
                        const target = elem.closest('[data-id]');
                        if(target && !target.classList.contains('matched')) target.classList.add('highlight');
                    }
                };
                
                const end = (ev) => {
                    const t = ev.changedTouches ? ev.changedTouches[0] : ev;
                    clone.style.display = 'none';
                    const target = document.elementFromPoint(t.clientX, t.clientY)?.closest('[data-id]');
                    
                    if (target && target.dataset.id === el.dataset.id && !target.classList.contains('matched')) {
                        app.sfx.correct(); app.audio.speak(el.dataset.word);
                        target.classList.add('matched'); target.classList.remove('highlight');
                        
                        // NEW LOGIC: If Hive game, replace content. Else append landed.
                        const pair = this.data.pairs.find(p => p.id === target.dataset.id);
                        if (this.data.motif === 'honeypot-hive') {
                             target.innerHTML = `
                                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; width:100%;">
                                    <div style="font-size:2rem; line-height:1; margin-bottom:-4px;">üçØ</div>
                                    <div style="font-size:0.8rem; font-weight:900; color:#78350f;">${pair.en}</div>
                                    <div style="width:40px; height:1px; background:rgba(120,53,15,0.3); margin:2px 0;"></div>
                                    <div class="zh-text" style="font-size:0.9rem; font-weight:900; color:#78350f;">${pair.zh}</div>
                                </div>`;
                        } else {
                             target.innerHTML += this.getConfig().landed({en:el.dataset.word});
                        }

                        el.remove();
                        this.matched++;
                        if(this.matched === this.data.pairs.length) setTimeout(()=>this.finish(), 1000);
                    } else {
                        app.sfx.incorrect();
                        this.mistakes++;
                        el.classList.remove('opacity-0');
                        el.style.opacity = '1';
                        if(target) target.classList.remove('highlight');
                    }
                    clone.remove();
                    document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', end);
                    document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end);
                };
                
                clone.style.left = r.left + 'px';
                clone.style.top = r.top + 'px';

                document.addEventListener('mousemove', move); document.addEventListener('mouseup', end);
                document.addEventListener('touchmove', move, {passive:false}); document.addEventListener('touchend', end);
            }
        }

        class ListenGame extends Game {
            start() {
                this.idx = 0;
                Views.container.innerHTML = `
                    ${this.header()}
                    <div id="listen-area" class="listen-area"></div>
                    <div class="game-footer">
                        <div class="progress-dots"></div>
                        <button id="next-btn" class="next-question-btn hidden">Next ‚ûú</button>
                    </div>`;
                this.renderQ();
            }
            renderQ() {
                const q = this.data.questions[this.idx];
                const parts = q.text.split('____');
                const area = document.getElementById('listen-area');
                document.querySelector('.progress-dots').innerHTML = this.data.questions.map((_,i)=>`<div class="progress-dot ${i===this.idx?'current':(i<this.idx?'completed':'')}"></div>`).join('');
                area.innerHTML = `
                    <div class="sentence-box-compact">
                        <button class="inline-speaker" onclick="app.audio.speak('${q.fullSentence}')">üîä</button>
                        <span>${parts[0]}</span>
                        <span id="blank" class="blank-spot">?</span>
                        <span>${parts[1]||''}</span>
                    </div>
                    <div class="word-bank">
                        ${[...q.options].sort(()=>Math.random()-0.5).map(o => `<button class="word-option" onclick="game.check('${o}', this)">${o}</button>`).join('')}
                    </div>
                `;
                setTimeout(() => app.audio.speak(q.fullSentence), 500);
                const nextBtn = document.getElementById('next-btn');
                nextBtn.classList.add('hidden');
                nextBtn.onclick = () => {
                    if(this.idx < this.data.questions.length-1) { this.idx++; this.renderQ(); }
                    else this.finish();
                };
            }
            check(word, btn) {
                const q = this.data.questions[this.idx];
                app.audio.speak(word);
                document.querySelectorAll('.word-option').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                document.getElementById('blank').textContent = word;
                document.getElementById('blank').classList.add('filled');
                if(word === q.blank) {
                    app.sfx.correct();
                    btn.classList.add('correct');
                    document.querySelectorAll('.word-option').forEach(b=>b.disabled=true);
                    const nb = document.getElementById('next-btn');
                    nb.textContent = this.idx === this.data.questions.length-1 ? 'Finish' : 'Next ‚ûú';
                    nb.classList.remove('hidden');
                } else {
                    app.sfx.incorrect();
                    this.mistakes++;
                    btn.classList.add('wrong');
                    setTimeout(() => { btn.classList.remove('wrong','selected'); document.getElementById('blank').textContent='?'; }, 500);
                }
            }
        }
        window.game = null;
        const _origListen = ListenGame.prototype.start; ListenGame.prototype.start = function(){ window.game = this; _origListen.call(this); };

        class DrawGame extends Game {
            start() {
                // UPDATED: Added Undo/Clear/Save buttons
                Views.container.innerHTML = `
                    ${this.header()}
                    <div class="draw-container">
                        <div class="draw-canvas-wrapper"><canvas id="cvs" class="draw-canvas"></canvas></div>
                        <div class="draw-toolbar">
                            <button class="tool-btn active" id="t-brush">üñåÔ∏è</button>
                            <button class="tool-btn" id="t-erase">üßΩ</button>
                            <button class="tool-btn" id="t-undo">‚Ü©Ô∏è</button>
                            <div style="width:1px;height:24px;background:#ddd;margin:0 2px;"></div>
                            <!-- UPDATED PALETTE -->
                            <button class="color-btn" style="background:#FF6B00"></button>
                            <button class="color-btn" style="background:#FFD700"></button>
                            <button class="color-btn" style="background:#22C55E"></button>
                            <button class="color-btn" style="background:#3B82F6"></button>
                            <button class="color-btn" style="background:#A855F7"></button>
                            <button class="color-btn" style="background:#EC4899"></button>
                            <button class="color-btn" style="background:#000"></button>
                            <button class="color-btn" style="background:#8B4513"></button>
                            <button class="color-btn" style="background:#9CA3AF"></button>
                            
                            <div style="width:1px;height:24px;background:#ddd;margin:0 2px;"></div>
                            <button class="tool-btn" id="t-clear">üóëÔ∏è</button>
                            <button class="tool-btn" id="t-save">üíæ</button>
                            <button class="done-btn" onclick="game.finish()">‚úì Done</button>
                        </div>
                    </div>`;
                window.game = this;
                
                const cvs = document.getElementById('cvs');
                const ctx = cvs.getContext('2d');
                let history = []; 
                
                const saveState = () => {
                    history.push(ctx.getImageData(0,0,cvs.width,cvs.height));
                    if(history.length>10) history.shift();
                };

                const resize = () => {
                    const r = cvs.parentElement.getBoundingClientRect();
                    cvs.width = (r.width-20) * 2; cvs.height = (r.height-20) * 2;
                    cvs.style.width = (r.width-20)+'px'; cvs.style.height = (r.height-20)+'px';
                    ctx.scale(2,2); ctx.lineCap='round'; ctx.lineJoin='round';
                    const img = new Image(); img.src = this.data.backgroundImage;
                    img.onload = () => {
                         const s = Math.min((r.width-20)/img.width, (r.height-20)/img.height) * 0.9;
                         ctx.drawImage(img, (r.width-20 - img.width*s)/2, (r.height-20 - img.height*s)/2, img.width*s, img.height*s);
                         saveState();
                    };
                };
                setTimeout(resize, 10);
                
                let drawing = false, color = '#FF6B00', size = 5, mode = 'brush';
                
                const getPos = (e) => {
                    const r = cvs.getBoundingClientRect();
                    const t = e.touches ? e.touches[0] : e;
                    return { x: t.clientX - r.left, y: t.clientY - r.top };
                };
                
                const start = (e) => { 
                    e.preventDefault(); drawing=true; 
                    saveState(); 
                    ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x, p.y); 
                };
                const move = (e) => {
                    if(!drawing) return; e.preventDefault();
                    const p = getPos(e);
                    ctx.globalCompositeOperation = mode==='erase'?'destination-out':'source-over';
                    ctx.strokeStyle = mode==='erase'?'rgba(0,0,0,1)':color;
                    ctx.lineWidth = mode==='erase'?20:size;
                    ctx.lineTo(p.x, p.y); ctx.stroke();
                };
                const end = () => drawing=false;
                
                cvs.onmousedown = cvs.ontouchstart = start;
                cvs.onmousemove = cvs.ontouchmove = move;
                cvs.onmouseup = cvs.onmouseleave = cvs.ontouchend = end;
                
                const setActive = (id) => { document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); };
                
                document.getElementById('t-brush').onclick=function(){mode='brush'; setActive('t-brush');};
                document.getElementById('t-erase').onclick=function(){mode='erase'; setActive('t-erase');};
                
                document.getElementById('t-undo').onclick=function(){
                    if(history.length>0) {
                        ctx.putImageData(history.pop(),0,0);
                    }
                };
                
                document.getElementById('t-clear').onclick=function(){
                    if(confirm('Clear all?')) {
                        ctx.fillStyle='white'; ctx.fillRect(0,0,cvs.width/2, cvs.height/2); 
                        resize(); 
                    }
                };
                
                document.getElementById('t-save').onclick=function(){
                    const link = document.createElement('a');
                    link.download = 'my-drawing.png';
                    link.href = cvs.toDataURL();
                    link.click();
                };

                document.querySelectorAll('.color-btn').forEach(b => b.onclick=function(){
                    color = this.style.background;
                    mode='brush'; setActive('t-brush');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
